<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bank Early Warning System ‚Äî Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        
        <style>
                /* Global & Custom Layout Styling */
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
                body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f4f7f9; display: flex; min-height: 100vh; margin: 0; }
                
                /* Layout Structure */
                .sidebar { width: 250px; background-color: #ffffff; box-shadow: 2px 0 5px rgba(0,0,0,0.05); padding: 20px 0; display: flex; flex-direction: column; flex-shrink: 0; }
                .main-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; }
                .header { background-color: #ffffff; border-bottom: 1px solid #e5e7eb; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
                .content-area { flex-grow: 1; padding: 30px; max-width: 100%; }
                
                /* Sidebar Components */
                .logo { font-size: 20px; font-weight: 800; color: #4f46e5; padding: 0 20px 20px; border-bottom: 1px solid #f3f4f6; margin-bottom: 10px; }
                .nav-item { padding: 10px 20px; color: #4b5563; text-decoration: none; display: flex; align-items: center; gap: 10px; font-weight: 500; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
                .nav-item:hover, .nav-item.active { background-color: #eef2ff; color: #4f46e5; border-right: 3px solid #4f46e5; }
                
                /* Card Overrides (Existing) */
                .card { box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 12px; border: 1px solid #e5e7eb; }
                .stat-card { border-radius: 12px; padding: 16px; background-color: white; border: 1px solid #f3f4f6; }
                .input-field { transition: border-color 0.2s; }
                .input-field:focus { border-color: #4f46e5; box-shadow: 0 0 0 1px #4f46e5; }
                .cont-positive { color: #dc2626; } /* Red (Increased Risk) */
                .cont-negative { color: #059669; } /* Green (Reduced Risk) */
        </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">EWS Portal</div>
        <nav>
            <div class="nav-item active" id="navDashboard">üìä Dashboard</div>
            <div class="nav-item" id="navRisk">üìà Risk Management</div>
            <div class="nav-item" id="navModels">üß† Model Performance</div>
            <div class="nav-item" id="navAdmin">‚öôÔ∏è Admin Portal</div>
        </nav>
    </aside>

    <div class="main-content-wrapper">
        
        <header class="header">
            <h1 class="text-2xl font-bold text-gray-800">Early Warning System Dashboard</h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                    <span>Welcome, Analyst</span>
                </div>
                <button id="logoutBtn" type="button" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition duration-150">Logout</button>
            </div>
        </header>

        <main class="content-area">
            <div class="max-w-full">
                
                <section class="mb-8">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">System Overview</h2>
                    <div id="statsSection" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="stat-card">
                            <div class="text-xs font-medium text-gray-500">Total Predictions</div>
                            <div id="statTotal" class="text-2xl font-bold text-gray-800 mt-1">‚Äî</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-xs font-medium text-gray-500">Default Rate (Overall)</div>
                            <div id="statRate" class="text-2xl font-bold text-gray-800 mt-1">‚Äî</div>
                        </div>
                        <div class="stat-card bg-red-50 border-red-200">
                            <div class="text-xs font-medium text-red-600">New High-Risk Alerts</div>
                            <div id="statHighAlerts" class="text-2xl font-bold text-red-600 mt-1">‚Äî</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-xs font-medium text-gray-500">Model Status</div>
                            <div id="statModel" class="text-2xl font-bold text-green-600 mt-1">Ready</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-xs font-medium text-gray-500">Uptime (min)</div>
                            <div id="statUptime" class="text-2xl font-bold text-gray-800 mt-1">‚Äî</div>
                        </div>
                    </div>
                </section>

                <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    
                    <div class="lg:col-span-2 card p-6 bg-white">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Loan Risk Prediction</h2>
                        <form id="predictionForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <label class="block"><span class="text-xs font-medium text-gray-500">Loan Limit</span><select name="loan_limit" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="nlt">Not Limit</option><option value="cf">CF</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Gender</span><select name="Gender" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="Male">Male</option><option value="Female">Female</option><option value="Joint">Joint</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Approval in Advance</span><select name="approv_in_adv" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="nopre">No Pre-Approval</option><option value="pre">Pre-Approval</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Loan Type</span><select name="loan_type" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="type1">Type 1</option><option value="type2">Type 2</option><option value="type3">Type 3</option></select></label>

                            <label class="block"><span class="text-xs font-medium text-gray-500">Loan Purpose</span><select name="loan_purpose" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="p1">Purchase</option><option value="p2">Refinance</option><option value="p3">Cash Out</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Credit Worthiness</span><select name="Credit_Worthiness" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="good">Good</option><option value="bad">Bad</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Open Credit</span><select name="open_credit" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="nopc">No Open Credit</option><option value="pco">PCO</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Business or Purpose</span><select name="business_or_purpose" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="bp1">BP1</option><option value="bp2">BP2</option><option value="bp3">BP3</option></select></label>

                            <label class="block"><span class="text-xs font-medium text-gray-500">Negative Ammortization</span><select name="Neg_ammortization" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="not_neg">No</option><option value="neg_amm">Yes</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Interest Only</span><select name="interest_only" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="not_int">No</option><option value="int_only">Yes</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Lump Sum Payment</span><select name="lump_sum_payment" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="not_lpsm">No</option><option value="lpsm">Yes</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Occupancy Type</span><select name="Occupancy_Type" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="pr">Primary</option><option value="ir">Investment</option></select></label>

                            <label class="block"><span class="text-xs font-medium text-gray-500">Secured By</span><select name="Secured_by" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="home">Home</option><option value="land">Land</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Total Units</span><select name="total_units" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="1U">1 Unit</option><option value="2U">2 Units</option><option value="3U">3 Units</option><option value="4U">4 Units</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Credit Type</span><select name="credit_type" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="CIB">CIB</option><option value="EXP">EXP</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Co-Applicant Credit Type</span><select name="co_applicant_credit_type" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="CIB">CIB</option><option value="EXP">EXP</option><option value="NA">NA</option></select></label>

                            <label class="block"><span class="text-xs font-medium text-gray-500">Age</span><select name="age" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="25-34">25-34</option><option value="35-44">35-44</option><option value="45-54">45-54</option><option value="55-64">55-64</option><option value="65-74">65-74</option><option value="<25"><25</option><option value=">74">>74</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Submission Method</span><select name="submission_of_application" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="to_inst">To Institution</option><option value="not_inst">Not Institution</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Region</span><select name="Region" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="North">North</option><option value="South">South</option><option value="East">East</option><option value="West">West</option></select></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Security Type</span><select name="Security_Type" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="direct">Direct</option><option value="indirect">Indirect</option></select></label>

                            <label class="block"><span class="text-xs font-medium text-gray-500">Rate of Interest (%)</span><input type="number" step="0.01" name="rate_of_interest" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm" value="4.5" required></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Interest Rate Spread</span><input type="number" step="0.01" name="Interest_rate_spread" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm" value="0.5" required></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Upfront Charges ($)</span><input type="number" step="0.01" name="Upfront_charges" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm" value="1500.0" required></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Term (months)</span><input type="number" step="1.0" name="term" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm" value="360.0" required></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Income ($/mo)</span><input type="number" step="0.01" name="income" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm" value="7000.0" required></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">Credit Score</span><input type="number" step="1.0" name="Credit_Score" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm" value="750.0" required></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">LTV (%)</span><input type="number" step="0.01" name="LTV" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm" value="80.0" required></label>
                            <label class="block"><span class="text-xs font-medium text-gray-500">DTIR1 (%)</span><input type="number" step="0.01" name="dtir1" class="input-field mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm" value="40.0" required></label>
                            
                            <div class="col-span-1 sm:col-span-2 flex justify-between space-x-3 mt-4">
                                <button id="submitBtn" type="submit" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition duration-150 flex items-center justify-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m4 0a2 2 0 002 2h2a2 2 0 002-2m0 0V9a1 1 0 00-1-1H7a1 1 0 00-1 1v10m9 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    <span>Run Risk Prediction</span>
                                </button>
                                <button id="explainBtn" type="button" class="px-4 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-sm font-semibold transition duration-150">
                                    Feature Explainer
                                </button>
                                <button id="exportReportBtn" type="button" class="px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition duration-150">
                                    Export Report (PDF)
                                </button>
                                <button id="resetBtn" type="button" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-semibold transition duration-150">
                                    Reset
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="lg:col-span-1 card p-6 bg-white">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Prediction Result</h2>
                        <div id="resultOutput">
                            <div class="flex items-center space-x-2 mb-4">
                                <div id="resultStatus" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-700">Awaiting Prediction</div>
                                <div id="resultProbability" class="text-2xl font-bold text-gray-800">‚Äî</div>
                            </div>
                            <div class="mb-4">
                                <canvas id="probChart" height="150"></canvas>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-md font-semibold mb-2 text-gray-700">Top Feature Contributions (SHAP)</h3>
                                <div id="contributionsList" class="space-y-1">
                                    <div class="text-sm text-gray-500">Run a prediction to see feature impact.</div>
                                </div>
                            </div>
                            <div id="alertMessage" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm font-medium">
                                <strong>‚ö†Ô∏è High Risk Alert!</strong> This loan exceeds the risk threshold.
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-8">
                    <div class="card p-6 bg-white">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Macro-Economic Indicators Trend (Last 12 Months)</h2>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <canvas id="macroTrendChart" height="100"></canvas>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Monitors key indicators like GDP Growth, Market Index YoY, and Unemployment Rate for systemic risk assessment.</p>
                    </div>
                </section>

                <section class="mb-8">
                    <div class="card p-6 bg-white">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Recent Predictions History</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Probability</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Top Driver</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alert</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="px-6 py-4 text-sm text-gray-500 text-center">Loading prediction history...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

            </div>
        </main>

    </div>

    <script>
        // --- Navigation ---
        document.getElementById('navRisk').addEventListener('click', () => { window.location.href = 'risk_management.html'; });
        document.getElementById('navModels').addEventListener('click', () => { window.location.href = 'model_performance.html'; });
        document.getElementById('navAdmin').addEventListener('click', () => { window.location.href = 'admin.html'; });

        // --- Logout ---
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            const res = await fetch(window.location.origin + '/admin-logout', { method: 'POST', credentials: 'same-origin' });
            if (res.redirected) {
                window.location.href = res.url;
            } else {
                window.location.href = '/admin-login';
            }
        });

        // --- API & Chart Setup --- 
        const API_URL = window.location.origin + '/predict';
        const HISTORY_URL = window.location.origin + '/predictions';
        const STATS_URL = window.location.origin + '/stats';
        const MACRO_URL = window.location.origin + '/api/macro_indicators';

        // Chart.js donut for probability
        const ctx = document.getElementById('probChart').getContext('2d');
        let probChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Default', 'Non-default'],
                datasets: [{
                    data: [0.5, 0.5],
                    backgroundColor: ['#f87171', '#34d399'],
                    hoverBackgroundColor: ['#ef4444', '#10b981'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                }
            }
        });
        
        // Chart.js for Macro Indicators Trend (NEW)
        const macroCtx = document.getElementById('macroTrendChart').getContext('2d');
        let macroTrendChart = new Chart(macroCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'GDP Growth Rate (%)', data: [], borderColor: '#4f46e5', tension: 0.3, fill: false },
                    { label: 'Market Index YoY (%)', data: [], borderColor: '#059669', tension: 0.3, fill: false },
                    { label: 'Unemployment Rate (%)', data: [], borderColor: '#f97316', tension: 0.3, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'Rate (%)' } },
                    x: { title: { display: true, text: 'Month' } }
                }
            }
        });


        // --- Helper Functions ---
        const formatProbability = (p) => `${(p * 100).toFixed(2)}%`;
        const formatUptime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            return `${minutes} min`;
        };
        const createContributionsList = (contributions) => {
            if (!contributions || Object.keys(contributions).length === 0) {
                return '<div class="text-sm text-gray-500">No feature contributions available.</div>';
            }
            // Sort by absolute value
            const sorted = Object.entries(contributions)
                .map(([k, v]) => ({ k, v }))
                .sort((a, b) => Math.abs(b.v) - Math.abs(a.v))
                .slice(0, 10); // Show top 10

            return sorted.map(item => {
                const isPositive = item.v > 0;
                const colorClass = isPositive ? 'cont-positive' : 'cont-negative';
                const sign = isPositive ? '‚Üë' : '‚Üì';
                return `<div class="flex justify-between items-center border-b border-gray-100 py-1.5">
                            <div class="text-xs font-medium text-gray-600">${item.k}</div>
                            <div class="text-sm font-semibold ${colorClass}">${sign} ${Math.abs(item.v).toFixed(4)}</div>
                        </div>`;
            }).join('');
        }

        // --- Fetch Data Functions ---
        async function fetchStats() {
            try {
                const res = await fetch(STATS_URL, { credentials: 'same-origin' });
                if (res.status === 401) { window.location.href = '/admin-login'; return; }
                const stats = await res.json();

                document.getElementById('statTotal').innerText = stats.total_predictions.toLocaleString();
                document.getElementById('statRate').innerText = formatProbability(stats.default_rate);
                document.getElementById('statUptime').innerText = formatUptime(stats.uptime_seconds);
                document.getElementById('statHighAlerts').innerText = stats.high_risk_alerts.toLocaleString(); // NEW STAT
                
                const modelStatusEl = document.getElementById('statModel');
                modelStatusEl.innerText = stats.model_status;
                if (stats.model_status === 'Ready') {
                    modelStatusEl.classList.replace('text-red-600', 'text-green-600');
                } else {
                    modelStatusEl.classList.replace('text-green-600', 'text-red-600');
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        async function fetchMacroIndicators() {
            try {
                const res = await fetch(MACRO_URL); // Public API (no credentials)
                if (!res.ok) throw new Error('Failed to fetch macro indicators');
                const data = await res.json();

                const labels = data.map(item => item.timestamp);
                const gdp = data.map(item => item.gdp_growth_rate);
                const market = data.map(item => item.market_index_yoy);
                const unemploy = data.map(item => item.unemployment_rate);

                macroTrendChart.data.labels = labels;
                macroTrendChart.data.datasets[0].data = gdp;
                macroTrendChart.data.datasets[1].data = market;
                macroTrendChart.data.datasets[2].data = unemploy;
                macroTrendChart.update();
            } catch (error) {
                console.error('Error fetching macro indicators:', error);
                // Optionally show an error message in the chart area
            }
        }


        async function fetchHistory() {
            try {
                const res = await fetch(HISTORY_URL, { credentials: 'same-origin' });
                if (res.status === 401) { window.location.href = '/admin-login'; return; }
                const history = await res.json();
                
                const tableBody = document.getElementById('historyTable');
                tableBody.innerHTML = '';

                if (history.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-sm text-gray-500 text-center">No predictions yet.</td></tr>';
                    return;
                }

                history.forEach(item => {
                    const statusText = item.prediction_status === 1 ? 'Default' : 'Non-default';
                    const statusColor = item.prediction_status === 1 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                    const topDriver = Object.entries(item.feature_contributions || {})
                        .map(([k, v]) => ({ k, v }))
                        .sort((a, b) => Math.abs(b.v) - Math.abs(a.v))[0];
                    
                    const driverText = topDriver ? `${topDriver.k} (${topDriver.v > 0 ? '‚Üë' : '‚Üì'})` : 'N/A';
                    
                    const alertText = item.alerts && item.alerts.length > 0 ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-500 text-white">ALERT</span>` : '-';
                    
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(item.timestamp).toLocaleTimeString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusText}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatProbability(item.default_probability)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${driverText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${alertText}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching history:', error);
                document.getElementById('historyTable').innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-sm text-red-500 text-center">Failed to load history.</td></tr>';
            }
        }
        
        // --- Event Listeners ---
        const form = document.getElementById('predictionForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            submitBtn.disabled = true;
            submitBtn.querySelector('span').innerText = 'Calculating...';
            // Simple loading state
            const initialText = submitBtn.querySelector('span').innerText;
            const initialIcon = submitBtn.querySelector('svg').outerHTML;
            submitBtn.innerHTML = '<svg class="animate-spin w-5 h-5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round" stroke-dasharray="31.4" stroke-dashoffset="15.7"></circle></svg> <span>Calculating...</span>';


            const data = Object.fromEntries(new FormData(form).entries());
            
            // Convert numerical inputs to float/int
            ['rate_of_interest', 'Interest_rate_spread', 'Upfront_charges', 'term', 'income', 'Credit_Score', 'LTV', 'dtir1'].forEach(key => {
                data[key] = parseFloat(data[key]);
            });

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'same-origin'
                });

                if (res.status === 401) { window.location.href = '/admin-login'; return; }

                if (!res.ok) {
                    const err = await res.json().catch(()=>({detail:'Prediction failed'}));
                    throw new Error(err.detail || 'Prediction failed');
                }

                const result = await res.json();

                const probability = result.default_probability;
                const nonDefaultProb = 1 - probability;
                const predictionStatus = result.prediction_status;
                const isHighRisk = result.alert !== null;

                // 1. Update Result Display
                document.getElementById('resultProbability').innerText = formatProbability(probability);
                
                const statusEl = document.getElementById('resultStatus');
                statusEl.innerText = predictionStatus === 1 ? 'HIGH RISK (DEFAULT)' : 'LOW RISK (NON-DEFAULT)';
                statusEl.classList.remove('bg-red-100', 'bg-green-100', 'text-red-800', 'text-green-800', 'bg-gray-200', 'text-gray-700');
                statusEl.classList.add(predictionStatus === 1 ? 'bg-red-100' : 'bg-green-100', predictionStatus === 1 ? 'text-red-800' : 'text-green-800');
                
                // 2. Update Doughnut Chart
                probChart.data.datasets[0].data = [probability, nonDefaultProb];
                probChart.data.datasets[0].backgroundColor = [predictionStatus === 1 ? '#ef4444' : '#f87171', predictionStatus === 1 ? '#34d399' : '#10b981'];
                probChart.update();
                
                // 3. Update Contributions List
                document.getElementById('contributionsList').innerHTML = createContributionsList(result.feature_contributions);
                
                // 4. Update Alert Message (NEW)
                const alertMessageEl = document.getElementById('alertMessage');
                if (isHighRisk) {
                    alertMessageEl.classList.remove('hidden');
                } else {
                    alertMessageEl.classList.add('hidden');
                }
                
                // 5. Refresh History and Stats
                fetchHistory();
                fetchStats();

            } catch (error) {
                console.error('Prediction Error:', error);
                alert('Prediction failed: ' + error.message);
                
                // Reset to default on error
                document.getElementById('resultProbability').innerText = '‚Äî';
                document.getElementById('resultStatus').innerText = 'ERROR';
                document.getElementById('resultStatus').classList.remove('bg-red-100', 'bg-green-100', 'text-red-800', 'text-green-800');
                document.getElementById('resultStatus').classList.add('bg-red-100', 'text-red-800');
                document.getElementById('contributionsList').innerHTML = '<div class="text-sm text-red-500">Error fetching contributions.</div>';
                document.getElementById('alertMessage').classList.add('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = initialIcon + ' <span>' + initialText + '</span>';
            }
        });

        document.getElementById('explainBtn').addEventListener('click', async () => {
             alert('Global Feature Explainer: This would typically open a modal showing a global SHAP summary plot. (Not fully implemented on frontend)');
        });

        document.getElementById('exportReportBtn').addEventListener('click', async () => {
            const loadingIndicator = document.getElementById('exportReportBtn');
            const initialText = loadingIndicator.innerText;
            loadingIndicator.innerText = 'Generating PDF...';
            loadingIndicator.disabled = true;

            const data = Object.fromEntries(new FormData(form).entries());
            ['rate_of_interest', 'Interest_rate_spread', 'Upfront_charges', 'term', 'income', 'Credit_Score', 'LTV', 'dtir1'].forEach(key => {
                data[key] = parseFloat(data[key]);
            });

            try {
                const r = await fetch(window.location.origin + '/export_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'same-origin'
                });

                if (r.status === 401) { window.location.href = '/admin-login'; return; }

                if (!r.ok) {
                    const err = await r.json().catch(()=>({detail:'Export failed'}));
                    throw new Error(err.detail || 'Export failed');
                }

                const blob = await r.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'prediction_report_' + new Date().toISOString().slice(0, 10) + '.pdf';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (e) {
                alert('Export failed: ' + e.message);
            } finally {
                loadingIndicator.innerText = initialText;
                loadingIndicator.disabled = false;
            }
        });

        document.getElementById('resetBtn').addEventListener('click', ()=>{ form.reset(); });

        // on load
        fetchHistory();
        fetchStats();
        fetchMacroIndicators(); // NEW CALL
    </script>
</body>
</html>